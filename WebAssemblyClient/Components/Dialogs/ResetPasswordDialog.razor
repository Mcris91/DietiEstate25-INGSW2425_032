@using WebAssemblyClient.ApiService
@implements IDialogContentComponent<ForgotPasswordRequestDto>

@inject AuthApiService AuthApiService
@inject IToastService ToastService

@if (!_emailSent && !_codeValidated)
{
    <FluentTextField Label="Email" @bind-Value="Content.Email" TextFieldType="TextFieldType.Email" Style="width: 100%"></FluentTextField>
}
else if (_emailSent && !_codeValidated)
{
    <FluentTextField Label="Email" @bind-Value="Content.Email" TextFieldType="TextFieldType.Email" Style="width: 100%"></FluentTextField>
    <FluentLabel Typo="Typography.Body">Inserisci il codice di verifica</FluentLabel>
    <FluentNumberField Label="Codice" @bind-Value="_codice" TextFieldType="TextFieldType.Number" Style="width: 100%" HideStep="true"></FluentNumberField>
}
else
{
    <FluentLabel Typo="Typography.Body">Scegli una nuova password</FluentLabel>
    <FluentTextField Label="Nuova Password" @bind-Value="_newPassword" TextFieldType="TextFieldType.Password" Style="width: 100%"></FluentTextField>
    <FluentTextField Label="Conferma Nuova Password" @bind-Value="_newPasswordConfirm" TextFieldType="TextFieldType.Password" Style="width: 100%"></FluentTextField>
}

<FluentDialogFooter>
@if (!_emailSent && !_codeValidated)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.End">
        <FluentButton Appearance="Appearance.Accent"
                      OnClick="@SendForgotPasswordRequest">
            Richiedi Codice
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral"
                      OnClick="@Discard">
            Annulla
        </FluentButton>
    </FluentStack>
} 
else if (_emailSent && !_codeValidated)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.End">
        <FluentButton Appearance="Appearance.Accent"
                      OnClick="@SendValidationCodeRequest">
            Invia
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral"
                      OnClick="@Discard">
            Annulla
        </FluentButton>
    </FluentStack>
}
else
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.End">
        <FluentButton Appearance="Appearance.Accent"
                      OnClick="@SendPasswordResetRequest">
            Salva
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral"
                      OnClick="@Discard">
            Annulla
        </FluentButton>
    </FluentStack>
}
</FluentDialogFooter>

@code {
    [Parameter]
    public ForgotPasswordRequestDto Content { get; set; } = null!;
    
    [CascadingParameter]
    public FluentDialog? Dialog {get; set; }

    private ValidatePasswordResetTokenRequestDto _validateTokenDto = new();
    private ResetPasswordRequestDto _passwordRequestDto = new();
    
    private bool _emailSent;
    private bool _codeValidated;
    private string _newPassword = "";
    private string _newPasswordConfirm = "";
    private int _codice;
    
    private async Task SendForgotPasswordRequest()
    {
        var response = await AuthApiService.SendForgotPasswordRequest(Content);
        switch (response)
        {
            case "":
                ToastService.ShowSuccess("Richiesta inviata con successo. A breve ti sarà inviato un codice via email");
                _emailSent = true;
                break;
            default:
                ToastService.ShowWarning(response);
                break;
        }
    }

    private async Task SendValidationCodeRequest()
    {
        _validateTokenDto = new ValidatePasswordResetTokenRequestDto()
        {
            Email = Content.Email,
            Token = _codice
        };
        var response = await AuthApiService.SendValidationCodeRequest(_validateTokenDto);
        switch (response)
        {
            case "":
                ToastService.ShowSuccess("Codice inserito valido. Ora puoi creare una nuova password");
                _codeValidated = true;
                break;
            default:
                ToastService.ShowWarning(response);
                break;
        }
    }

    private async Task SendPasswordResetRequest()
    {
        _passwordRequestDto = new ResetPasswordRequestDto()
        {
            Email = Content.Email,
            Password = _newPassword,
            PasswordConfirm = _newPasswordConfirm
        };
        var response = await AuthApiService.SendPasswordResetRequest(_passwordRequestDto);
        switch (response)
        {
            case "":
                ToastService.ShowSuccess("Password cambiata con successo!");
                await CloseAsync();
                _codeValidated = true;
                break;
            default:
                ToastService.ShowWarning("La password è troppo debole o è diversa dalla conferma");
                break;
        }
    }
    
    private async Task CloseAsync()
    {
        await Dialog!.CloseAsync();
    }
    
    private async Task Discard()
    {
        if (Dialog != null)
        {
            await Dialog.CancelAsync();
        }
    }
}