@using WebAssemblyClient.ApiService
@using WebAssemblyClient.Extensions
@implements IDialogContentComponent<ForgotPasswordRequestDto>

@inject HostAuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JsRuntime
@inject AuthApiService AuthApiService
@inject NavigationManager NavigationManager
@inject IToastService ToastService

@if (!_emailSent && !_codeValidated)
{
    <FluentTextField Label="Email" @bind-Value="Content.Email" TextFieldType="TextFieldType.Email" Style="width: 100%"></FluentTextField>
    
    <FluentDialogFooter>
        <FluentStack HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="@SendForgotPasswordRequest">
                Richiedi Codice
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                          OnClick="@Discard">
                Annulla
            </FluentButton>
        </FluentStack>
    </FluentDialogFooter>
} 
else if (_emailSent && !_codeValidated)
{
    <FluentTextField Label="Email" @bind-Value="Content.Email" TextFieldType="TextFieldType.Email" Style="width: 100%"></FluentTextField>
    <FluentLabel Typo="Typography.Body">Inserisci il codice di verifica</FluentLabel>
    <FluentNumberField Label="Codice" @bind-Value="Codice" TextFieldType="TextFieldType.Number" Style="width: 100%"></FluentNumberField>
    
    <FluentDialogFooter>
        <FluentStack HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="@SendForgotPasswordRequest">
                Invia
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                          OnClick="@Discard">
                Annulla
            </FluentButton>
        </FluentStack>
    </FluentDialogFooter>
}
else
{
    <FluentLabel Typo="Typography.Body">Scegli una nuova password</FluentLabel>
    <FluentTextField Label="Nuova Password" @bind-Value="newPassword" TextFieldType="TextFieldType.Password" Style="width: 100%"></FluentTextField>
    <FluentTextField Label="Conferma Nuova Password" @bind-Value="newPasswordConfirm" TextFieldType="TextFieldType.Password" Style="width: 100%"></FluentTextField>
    
    <FluentDialogFooter>
        <FluentStack HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="@SendForgotPasswordRequest">
                Salva
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                          OnClick="@Discard">
                Annulla
            </FluentButton>
        </FluentStack>
    </FluentDialogFooter>
}

@code {
    [Parameter]
    public ForgotPasswordRequestDto Content { get; set; } = null!;
    
    [CascadingParameter]
    public FluentDialog? Dialog {get; set; }

    private ValidatePasswordResetTokenRequestDto _validateTokenDto = new();
    
    private bool _emailSent;
    private bool _codeValidated = false;
    private string newPassword;
    private string newPasswordConfirm;
    private int Codice;
    
    private async Task SendForgotPasswordRequest()
    {
        var response = await AuthApiService.SendForgotPasswordRequest(Content);
        switch (response)
        {
            case "":
                ToastService.ShowError("Richiesta inviata con successo. A breve ti sarà inviato un codice via email");
                _emailSent = true;
                break;
            case null:
                ToastService.ShowError("Si è verificato un errore imprevisto");
                break;
            default:
                ToastService.ShowWarning(response);
                break;
        }
    }

    private async Task SendValidationCodeRequest()
    {
        
        var response = await AuthApiService.SendValidationCodeRequest(new ValidatePasswordResetTokenRequestDto()
        {
            Email = Content.Email,
            Token = Codice
        });
        switch (response)
        {
            case "":
                _emailSent = true;
                break;
            case null:
                ToastService.ShowError("Si è verificato un errore imprevisto");
                break;
            default:
                ToastService.ShowWarning(response);
                break;
        }
    }
    
    private async Task CloseAsync()
    {
        await Dialog!.CloseAsync();
    }
    
    private async Task Discard()
    {
        if (Dialog != null)
        {
            await Dialog.CancelAsync();
        }
    }
}