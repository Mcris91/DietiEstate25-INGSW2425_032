@using WebAssemblyClient.ApiService
@using WebAssemblyClient.Components.Dialogs
@using WebAssemblyClient.Extensions
@inject AuthApiService AuthApiService
@inject IDialogService DialogService
@inject HostAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigator
@inject IToastService ToastService

<FluentDesignTheme Mode="@Mode" CustomColor="#EF4444" StorageName="theme"/>
<FluentAnchor Href="/" Appearance="Appearance.Outline">Home</FluentAnchor>

<AuthorizeView>
    <Authorized>
        @if (context.User.IsInRole("EstateAgent") || context.User.IsInRole("SystemAdmin") || context.User.IsInRole("SuperAdmin") || context.User.IsInRole("SupportAdmin"))
        {
            <FluentAnchor Href="/agent/dashboard" Appearance="Appearance.Outline">Dashboard</FluentAnchor>
        }else if (context.User.IsInRole("Client"))
        {
            <FluentAnchor Href="/client/activities" Appearance="Appearance.Outline">Le mie attività</FluentAnchor>
        }

        <FluentProfileMenu Image=""
                           HeaderLabel="@context.User.FindFirst("role")?.Value"
                           FullName="@context.User.FindFirst("given_name")?.Value"
                           Email="@context.User.FindFirst("email")?.Value" 
                           PopoverStyle="min-width: 330px;"
                           OnHeaderButtonClick="@SignOut">
            <FooterTemplate>
                <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                    <FluentGridItem>
                        <FluentSelect Width="150px"
                                      Items="@(Enum.GetValues<DesignThemeModes>())"
                                      @bind-SelectedOption="@Mode"/>
                    </FluentGridItem>
                    <FluentSpacer/>
                    <FluentAnchor Href="/user/profile" Appearance="Appearance.Hypertext">View Profile</FluentAnchor>
                </FluentStack>
            </FooterTemplate>
        </FluentProfileMenu>
    </Authorized>

    <NotAuthorized>
        <FluentButton Appearance="Appearance.Stealth"
                      @onclick="@OpenRegisterAgencyDialogAsync">Registra la tua azienda</FluentButton>
        <FluentButton IconStart="@(new Icons.Regular.Size20.PersonAccounts())"
                      Appearance="Appearance.Accent"
                      @onclick="@OpenLoginDialogAsync">Accedi</FluentButton>
    </NotAuthorized>
</AuthorizeView>

@code {
    private DesignThemeModes Mode { get; set; }
    private async Task SignOut()
    {
        await AuthApiService.Logout();
        Navigator.NavigateTo("/");
        AuthStateProvider.NotifyAuthenticationStateChanged();
    }

    private async Task OpenLoginDialogAsync()
    {
        LoginRequestDto loginUser = new() { Email = "", Password = "" };

        DialogParameters loginParameters = new()
        {
            Title = "Accedi",
            TitleTypo = Typography.H2,
            PrimaryAction = "Accedi",
            SecondaryAction = "Annulla",
            Width = "500px",
            PreventScroll = true
        };

        IDialogReference loginDialog = await DialogService.ShowDialogAsync<LoginDialog>(loginUser, loginParameters);
        DialogResult loginResult = await loginDialog.Result;

        if (loginResult.Data is not null && !loginResult.Cancelled)
        {
            if (loginResult.Data is UserRequestDto)
            {
                await OpenRegisterDialogAsync();
            } 
            else if (loginResult.Data is ForgotPasswordRequestDto)
            {
                await OpenForgotPasswordDialogAsync();
            }
            else
            {
                var loginRequest = loginResult.Data as LoginRequestDto;
                
                var response = await AuthApiService.Login(loginRequest);

                if (response != null)
                    AuthStateProvider.NotifyAuthenticationStateChanged();
                else 
                    ToastService.ShowError("Credenziali non corrette!");
            }
        }
    }

    private async Task OpenRegisterDialogAsync()
    {

        UserRequestDto registerUser = new()
        {
            FirstName = "",
            LastName = "",
            Email = "",
            Password = ""
        };

        DialogParameters registerParameters = new()
        {
            Title = "Registrati",
            TitleTypo = Typography.H2,
            Width = "500px",
            PreventScroll = true
        };

        IDialogReference registerDialog = await DialogService.ShowDialogAsync<RegisterDialog>(registerUser, registerParameters);
        DialogResult registerResult = await registerDialog.Result;

        if (registerResult.Data is not null && !registerResult.Cancelled)
        {
            var registerRequest = registerResult.Data as UserRequestDto;
            var response = await AuthApiService.Register(registerRequest);

            switch (response)
            {
                case "":
                    ToastService.ShowSuccess("Azienda registrata con successo! Controlla la mail per le credenziali di accesso.");
                    break;
                case null:
                    ToastService.ShowError("Si è verificato un errore imprevisto");
                    break;
                default:
                    ToastService.ShowWarning(response);
                    break;
            }
        }
    }


    private async Task OpenForgotPasswordDialogAsync()
    {
        ForgotPasswordRequestDto passwordrequest = new()
        {
            Email = "",
        };

        DialogParameters parameters = new()
        {
            Title = "Password dimenticata",
            TitleTypo = Typography.H2,
            Width = "500px",
            PreventScroll = true
        };

        IDialogReference resetDialog = await DialogService.ShowDialogAsync<ResetPasswordDialog>(passwordrequest, parameters);
        DialogResult resetResult = await resetDialog.Result;
    }
    
    private async Task OpenRegisterAgencyDialogAsync()
    {

        RegisterAgencyDto registerAgency = new()
        {
            Name = "",
            Email = "",
        };

        DialogParameters registerParameters = new()
        {
            Title = "Registra la tua azienda",
            TitleTypo = Typography.H2,
            PrimaryAction = "Registra",
            SecondaryAction = "Annulla",
            Width = "500px",
            PreventScroll = true
        };

        IDialogReference registerDialog = await DialogService.ShowDialogAsync<RegisterAgencyDialog>(registerAgency, registerParameters);
        DialogResult registerResult = await registerDialog.Result;

        if (registerResult.Data is not null && !registerResult.Cancelled)
        {
            var registerRequest = registerResult.Data as RegisterAgencyDto;
            var response = await AuthApiService.RegisterAgency(registerRequest);
            
            switch (response)
            {
                case "":
                    ToastService.ShowSuccess("Azienda registrata con successo! Controlla la mail per le credenziali di accesso.");
                    break;
                case null:
                    ToastService.ShowError("Si è verificato un errore imprevisto");
                    break;
                default:
                    ToastService.ShowWarning(response);
                    break;
            }

        }
    }
}