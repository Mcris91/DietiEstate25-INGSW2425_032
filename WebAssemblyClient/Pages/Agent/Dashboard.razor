@using System.Globalization
@using WebAssemblyClient.ApiService
@using WebAssemblyClient.Components.Dialogs
@using WebAssemblyClient.Data.Common
@using WebAssemblyClient.Extensions

@inject HostAuthenticationStateProvider AuthStateProvider
@inject ListingApiService ListingApiService
@inject BookingApiService BookingApiService
@inject UserApiService UserApiService
@inject OfferApiService OfferApiService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IToastService ToastService
@inject IJSRuntime JsRuntime

@page "/agent/dashboard"
<AuthorizeView Context="current_user">
  <Authorized>
  @if (current_user.User.IsInRole("EstateAgent") || current_user.User.IsInRole("SystemAdmin") || current_user.User.IsInRole("SuperAdmin") || current_user.User.IsInRole("SupportAdmin"))
  {
    <FluentGrid Spacing="2" Style="margin: 1rem 3rem;">
        <FluentGridItem xs="12" sm="12" md="8">
    
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
      <FluentGrid Style="width: 100%;">
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Inserzioni"
                             LeftInfo="Vendita" RightInfo="Affitto"
                             LeftNumber="@(_listingCounters?.ForSaleCount ?? 0)" 
                             RightNumber="@(_listingCounters?.ForRentCount ?? 0)"/>
        </FluentGridItem>
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Offerte"
                             LeftInfo="Totali" RightInfo="Attesa"
                             LeftNumber="@(_offersCounters?.TotalOffers ?? 0)"  
                             RightNumber="@(_offersCounters?.PendingOffers ?? 0)"/>
        </FluentGridItem>
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Prenotazioni"
                             LeftInfo="Prossime" RightInfo="Attesa"
                             LeftNumber="@(_bookingCounters?.ScheduledBookings ?? 0)" 
                             RightNumber="@(_bookingCounters?.PendingBookings ?? 0)"/>
        </FluentGridItem>
      </FluentGrid>  
      
      <FluentCard>
        <FluentTabs Size="TabSize.Medium">

          <FluentTab Label="Inserzioni" Id="tab-listings">
            <PagedDataGrid @ref="_listingGrid"
                           TItem="ListingResponseDto"
                           DataProvider="GetListingData"
                           PageSize="10"
                           OnRowClick="OnListingRowClick">
              <GridColumns>
                <PropertyColumn Title="Nome" Property="@((ListingResponseDto l) => l.Name)"/>
                <PropertyColumn Title="Tipologia" Property="@((ListingResponseDto l) => l.Type.Name)"/>
                <PropertyColumn Title="Prezzo" Property="@((ListingResponseDto l) => l.Price.ToString("C", new CultureInfo("it-IT")))"/>
                <TemplateColumn Title="Disponibilità" TGridItem="ListingResponseDto">
                  <FluentBadge Appearance="@(context.Available ? Appearance.Neutral : Appearance.Accent)" Circular="true">
                    @(context.Available ? "Disponibile" : "Occupata")
                  </FluentBadge>
                </TemplateColumn>
              </GridColumns>
            </PagedDataGrid>

          </FluentTab>
          <FluentTab Label="Offerte" Id="tab-offers">

            <PagedDataGrid @ref="_offerGrid"
                           TItem="OfferResponseDto"
                           DataProvider="GetOfferData"
                           PageSize="10"
                           OnRowClick="OnOfferRowClick">
              <GridColumns>
                <PropertyColumn Title="Cliente" Property="@((OfferResponseDto o) => o.CustomerName + " " + o.CustomerLastName)"/>
                <PropertyColumn Title="Contatto" Property="@((OfferResponseDto o) => o.CustomerEmail)"/>
                <PropertyColumn Title="Immobile" Property="@((OfferResponseDto o) => o.ListingName)"/>
                <PropertyColumn Title="Data" Property="@((OfferResponseDto o) => o.Date.ToString("dd/MM/yyyy"))"/>
                <PropertyColumn Title="Valore" Property="@((OfferResponseDto o) => o.Value.ToString("C", new CultureInfo("it-IT")))"/>
                <TemplateColumn Title="Stato" TGridItem="OfferResponseDto">
                  <FluentBadge Appearance=@(context.Status == OfferStatus.Pending ? Appearance.Neutral : Appearance.Accent) Circular="true">@(context.Status.ToString())</FluentBadge>
                </TemplateColumn>
                </GridColumns>
            </PagedDataGrid>

          </FluentTab>
          <FluentTab Label="Prenotazioni" Id="tab-bookings">
            
            <PagedDataGrid @ref="_bookingGrid"
                           TItem="BookingResponseDto"
                           DataProvider="GetBookingData"
                           PageSize="10"
                           OnRowClick="OnBookingrRowClick">
              <GridColumns>
                <PropertyColumn Title="Cliente" Property="@((BookingResponseDto b) => b.CustomerName + " " + b.CustomerLastName)"/>
                <PropertyColumn Title="Contatto" Property="@((BookingResponseDto b) => b.CustomerEmail)"/>
                <PropertyColumn Title="Immobile" Property="@((BookingResponseDto b) => b.ListingName)"/>
                <PropertyColumn Title="Data" Property="@((BookingResponseDto b) => b.DateMeeting.ToString("dd/MM/yyyy hh:mm"))"/>
                <TemplateColumn Title="Stato" TGridItem="BookingResponseDto">
                  <FluentBadge Appearance=@(context.Status == BookingStatus.Pending ? Appearance.Neutral : Appearance.Accent) Circular="true">@(context.Status.ToString())</FluentBadge>
                </TemplateColumn>
              </GridColumns>
            </PagedDataGrid>
            
          </FluentTab>
          @if (current_user.User.IsInRole("SuperAdmin") || current_user.User.IsInRole("SystemAdmin") || current_user.User.IsInRole("SupportAdmin"))
          {
            <FluentTab Label="Dipendenti" Id="tab-employee">
            
              <PagedDataGrid @ref="_employeeGrid"
                             TItem="UserResponseDto"
                             DataProvider="GetEmployeeData"
                             PageSize="10"
                             OnRowClick="OnEmployeeRowClick">
                <GridColumns>
                  <PropertyColumn Title="Agente" Property="@((UserResponseDto e) => e.FirstName + " " + e.LastName)"/>
                  <PropertyColumn Title="Contatto" Property="@((UserResponseDto e) => e.Email)"/>
                  <PropertyColumn Title="Ruolo" Property="@((UserResponseDto e) => e.Role)"/>
                </GridColumns>
              </PagedDataGrid>
            
            </FluentTab>
          }
          <div slot="end">
            @if (current_user.User.IsInRole("EstateAgent"))
            {
              <FluentButton IconStart="new Icons.Regular.Size20.Add()" OnClick="@(() => { Navigation.NavigateTo("/listing/create"); })">Aggiungi Inserzione</FluentButton>
            }
            @if (current_user.User.IsInRole("SuperAdmin") || current_user.User.IsInRole("SupportAdmin"))
            {
              <FluentButton IconStart="new Icons.Regular.Size20.Add()" OnClick="OpenCreateEmployeeDialog"> Aggiungi Agente</FluentButton>
            }
            <FluentButton IconStart="new Icons.Regular.Size20.DocumentArrowDown()" OnClick="DownloadReport">Stampa Report</FluentButton>
          </div>
        </FluentTabs>
      </FluentCard>
    </FluentStack>
    
  </FluentGridItem>
        <FluentGridItem xs="12" sm="12" md="4">
    <DetailsCard IsLoading="_isDetailsCardLoading"
                 TopSection="_detailsCardTopSection"
                 BottomSection="_detailsCardBottomSection">
      <Actions>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="5">
          <FluentLabel Typo="Typography.H5">Azioni</FluentLabel>
          @if (_loadedItem is ListingResponseDto listing)
          {
            <FluentGrid Spacing="1" Style="width: 100%;">
              <FluentGridItem xs="12">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.Play()" 
                              OnClick="@(() => { Navigation.NavigateTo($"View/{listing.Id}/"); })">
                  Visualizza
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="12">
                <FluentButton Style="width: 100%;" Disabled="@(!listing.Available || !current_user.User.IsInRole("EstateAgent"))" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Edit()"
                              OnClick="@(() => { Navigation.NavigateTo($"/listing/update/{listing.Id}/"); })">
                  Modifica
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.DocumentArrowDown()">
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.Share()">
                </FluentButton>
              </FluentGridItem>
            </FluentGrid>
          } else if (_loadedItem is OfferResponseDto offer)
          {
            <FluentGrid Spacing="1" Style="width: 100%;">
              <FluentGridItem xs="4">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Checkmark()"
                              OnClick="@(() => HandleOfferAction(offer.Id, true))" Disabled="@(!current_user.User.IsInRole("EstateAgent"))">
                  Accetta
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="4">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Dismiss()"
                              OnClick="@(() => HandleOfferAction(offer.Id, false))" Disabled="@(!current_user.User.IsInRole("EstateAgent"))">
                  Rifiuta
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="4">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Edit()"
                              OnClick="@(() => { Navigation.NavigateTo($"/listing/create/{offer.Id}/"); })" Disabled="@(!current_user.User.IsInRole("EstateAgent"))">
                  Contro-Offerta
                </FluentButton>
              </FluentGridItem>
            </FluentGrid>
          } else if (_loadedItem is BookingResponseDto booking && booking.Status == BookingStatus.Pending)
          {
            <FluentGrid Spacing="1" Style="width: 100%;">
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Checkmark()"
                              OnClick="@(() => HandleBookingAction(booking.Id, true))" Disabled="@(!current_user.User.IsInRole("EstateAgent"))">
                  Accetta
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Dismiss()"
                              OnClick="@(() => HandleBookingAction(booking.Id, false))" Disabled="@(!current_user.User.IsInRole("EstateAgent"))">
                  Rifiuta
                </FluentButton>
              </FluentGridItem>
            </FluentGrid>
          }
        </FluentStack>
      </Actions>
    </DetailsCard>
  </FluentGridItem>
    </FluentGrid>
  }
  </Authorized>
</AuthorizeView>


@code {

  private IJSObjectReference? _jsModule;
  private PagedDataGrid<ListingResponseDto> _listingGrid;
  private PagedDataGrid<OfferResponseDto> _offerGrid;
  private PagedDataGrid<BookingResponseDto> _bookingGrid;
  private PagedDataGrid<UserResponseDto> _employeeGrid;
  
  ListingFilterDto _filters = new();
  OfferFilterDto _offerFilters = new();
  BookingFilterDto _bookingFilters = new();
  UserFilterDto? _employeeFilters;

  private ListingAgentCountersResponseDto? _listingCounters;
  private OfferAgentCountersResponseDto? _offersCounters;
  private BookingAgentCountersResponseDto? _bookingCounters;

  private bool _isDetailsCardLoading;
  private Dictionary<string, string>? _detailsCardTopSection;
  private Dictionary<string, string>? _detailsCardBottomSection;
  private object? _loadedItem;
  
  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
      if (!firstRender) return;
      _jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/Dashboard.js");
      
      var user = await AuthStateProvider.GetAuthenticationStateAsync();
      var userId = user.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
      if (userId == null) return;
      
      var userRole = user.User.FindFirst("role")?.Value;

      if (userRole == "SuperAdmin")
      {
        var agencyId = user.User.FindFirst("AgencyId")?.Value;
        _employeeFilters = new UserFilterDto { AgencyId = Guid.Parse(agencyId) };
        await _employeeGrid.LoadData(1, 10);
      }
      
      _listingCounters = await ListingApiService.GetListingAgentCountersAsync();
      _offersCounters = await OfferApiService.GetOffersAgentCountersAsync();
      _bookingCounters = await BookingApiService.GetBookingsAgentCountersAsync();
      StateHasChanged();
  }

  private async Task<PagedResponseDto<ListingResponseDto>> GetListingData(int? pageNumber, int? pageSize)
  {
    return await ListingApiService.GetListingsAsync(_filters, pageNumber, pageSize);
  }

  private void OnListingRowClick(ListingResponseDto listing)
  {
    _isDetailsCardLoading = true;
    _detailsCardTopSection = new Dictionary<string, string>()
    {
      { "Nome", listing.Name },
      { "Città", listing.City },
      { "Indirizzo", listing.Address },
      { "Tipologia", listing.Type.Name },
      { "Prezzo", listing.Price.ToString("C", new CultureInfo("it-IT")) },
      { "Disponibilità", listing.Available ? "Disponibile" : "Occupata" },
      { "Servizi disponibili", listing.Services.Count().ToString() }
    };
    _detailsCardBottomSection = new Dictionary<string, string>()
    {
      { "Visualizzazioni", "350" },
      { "Preferiti", "123" },
      { "Offerenti", "75" },
      { "Offerte", "24" },
      { "Prenotazioni", "17" }
    };

    _loadedItem = listing;
    _isDetailsCardLoading = false;
  }
  
  
  private async Task<PagedResponseDto<OfferResponseDto>> GetOfferData(int? pageNumber, int? pageSize)
  {
    return await OfferApiService.GetOffersByAgentIdAsync(_offerFilters, pageNumber, pageSize);
  }
  
  private void OnOfferRowClick(OfferResponseDto offer)
  {
    _isDetailsCardLoading = true;
    _detailsCardTopSection = new Dictionary<string, string>()
    {
      { "Cliente", offer.CustomerName + " " + offer.CustomerLastName },
      { "Contatto", offer.CustomerEmail },
      { "Immobile", offer.ListingName },
      { "Data", offer.Date.ToString("dd/MM/yyyy") },
      { "Valore", offer.Value.ToString("C", new CultureInfo("it-IT")) },
      { "Stato", offer.Status.ToString() }
    };

    _detailsCardBottomSection = new Dictionary<string, string>();
    _loadedItem = offer;
    _isDetailsCardLoading = false;
  }
  
  private async Task<PagedResponseDto<BookingResponseDto>> GetBookingData(int? pageNumber, int? pageSize)
  {
    return await BookingApiService.GetBookingsByAgentIdAsync(_bookingFilters, pageNumber, pageSize);
  }
  
  private void OnBookingrRowClick(BookingResponseDto booking)
  {
    _isDetailsCardLoading = true;
    _detailsCardTopSection = new Dictionary<string, string>()
    {
      { "Cliente", booking.CustomerName + " " + booking.CustomerLastName },
      { "Contatto", booking.CustomerEmail },
      { "Immobile", booking.ListingName },
      { "Data", booking.DateMeeting.ToString("dd/MM/yyyy hh:mm") },
      { "Stato", booking.Status.ToString() }
    };

    _detailsCardBottomSection = new Dictionary<string, string>();
    _loadedItem = booking;
    _isDetailsCardLoading = false;
  }
  
  private async Task<PagedResponseDto<UserResponseDto>> GetEmployeeData(int? pageNumber, int? pageSize)
  {
    return _employeeFilters == null ? new PagedResponseDto<UserResponseDto>() : await UserApiService.GetEmployeesByAgencyId(_employeeFilters, pageNumber, pageSize);
  }
  
  private void OnEmployeeRowClick(UserResponseDto employee)
  {
    _isDetailsCardLoading = true;
    _detailsCardTopSection = new Dictionary<string, string>()
    {
      { "Impiegato", employee.FirstName + " " + employee.LastName },
      { "Email", employee.Email },
      { "Ruolo", employee.Role.ToString() },
    };

    _detailsCardBottomSection = new Dictionary<string, string>();
    _loadedItem = employee;
    _isDetailsCardLoading = false;
  }

  private async Task HandleOfferAction(Guid offerId, bool accept)
  {
    await OfferApiService.AcceptOrRejectOfferAsync(offerId, accept);
    _offersCounters = await OfferApiService.GetOffersAgentCountersAsync();
    _detailsCardTopSection = null;
    await _offerGrid.LoadData(1,10);
    await _listingGrid.LoadData(1, 10);
    await _bookingGrid.LoadData(1, 10);
    StateHasChanged();
  }
  
  private async Task HandleBookingAction(Guid bookingId, bool accept)
  {
    await BookingApiService.AcceptOrRejectBookingAsync(bookingId, accept);
    _bookingCounters = await BookingApiService.GetBookingsAgentCountersAsync();
    _detailsCardTopSection = null;
    await _offerGrid.LoadData(1,10);
    await _listingGrid.LoadData(1, 10);
    await _bookingGrid.LoadData(1, 10);
    StateHasChanged();
  }

  private async Task DownloadReport()
  {
    var file = await ListingApiService.GetReportAsync(_filters.AgentId);
    var fileName = "Report.xlsx";
    await _jsModule.InvokeVoidAsync("downloadFileFromStream", fileName, file);

  }
  
  private async Task OpenCreateEmployeeDialog()
  {

    UserRequestDto registerUser = new()
    {
      FirstName = "",
      LastName = "",
      Email = "",
      Password = ""
    };

    DialogParameters registerParameters = new()
    {
      Title = "Registrata un nuovo agente",
      TitleTypo = Typography.H2,
      Width = "500px",
      PreventScroll = true
    };

    IDialogReference registerDialog = await DialogService.ShowDialogAsync<RegisterDialog>(registerUser, registerParameters);
    DialogResult registerResult = await registerDialog.Result;

    if (registerResult.Data is not null && !registerResult.Cancelled)
    {
      UserRequestDto? registerRequest = registerResult.Data as UserRequestDto;
      await UserApiService.AddEmployee(registerRequest);
      ToastService.ShowSuccess("Agente registrato con successo!");
    }
  }
}