@using System.Globalization
@using DietiEstate.WebClient.ApiService
@using DietiEstate.WebClient.Data.Requests
@using DietiEstate.WebClient.Data.Responses
@using Microsoft.FluentUI.AspNetCore.Components.Icons.Color
@rendermode InteractiveServer

@inject ListingApiService ListingApiService

@page "/agent/dashboard"

<FluentGrid Spacing="2">
  <FluentGridItem xs="12" sm="12" md="8">
    
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
      <FluentGrid Style="width: 100%;">
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Inserzioni"
                             LeftInfo="Vendita" RightInfo="Affitto"
                             LeftNumber="@(_listingCounters?.ForSaleCount ?? 0)" 
                             RightNumber="@(_listingCounters?.ForSaleCount ?? 0)"/>
        </FluentGridItem>
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Offerte"
                             LeftInfo="Totali" RightInfo="Attesa"
                             LeftNumber="75" RightNumber="28"/>
        </FluentGridItem>
        <FluentGridItem xs="12" sm="4" md="4">
          <DashboardInfoCard Title="Prenotazioni"
                             LeftInfo="Prossime" RightInfo="Attesa"
                             LeftNumber="17" RightNumber="28"/>
        </FluentGridItem>
      </FluentGrid>  
      
      <FluentCard>
        <FluentTabs Size="TabSize.Medium">
          
          <FluentTab Label="Inserzioni" Id="tab-listings">
            
            <PagedDataGrid TItem="ListingResponseDto"
                           DataProvider="GetListingData"
                           PageSize="10"
                           OnRowClick="OnListingRowClick">
              <GridColumns>
                <PropertyColumn Title="Nome" Property="@((ListingResponseDto l) => l.Name)"/>
                <PropertyColumn Title="Tipologia" Property="@((ListingResponseDto l) => l.Type)"/>
                <PropertyColumn Title="Prezzo" Property="@((ListingResponseDto l) => l.Price.ToString("C", new CultureInfo("it-IT")))"/>
                <TemplateColumn Title="Disponibilità" TGridItem="ListingResponseDto">
                  <FluentBadge Appearance="@(context.Available ? Appearance.Neutral : Appearance.Accent)" Circular="true">
                    @(context.Available ? "Disponibile" : "Occupata")
                  </FluentBadge>
                </TemplateColumn>
              </GridColumns>
            </PagedDataGrid>
            
          </FluentTab>
          <FluentTab Label="Offerte" Id="tab-offers">
            Content for Offers tab.
          </FluentTab>
          <FluentTab Label="Prenotazioni" Id="tab-bookings">
            Content for Bookings tab.
          </FluentTab>
          
        </FluentTabs>
      </FluentCard>
    </FluentStack>
    
  </FluentGridItem>
  <FluentGridItem xs="12" sm="12" md="4">
    <DetailsCard IsLoading="_isDetailsCardLoading"
                 TopSection="_detailsCardTopSection"
                 BottomSection="_detailsCardBottomSection">
      <Actions>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="5">
          <FluentLabel Typo="Typography.H5">Azioni</FluentLabel>
          @if (_loadedItem is ListingResponseDto listing)
          {
            <FluentGrid Spacing="1" Style="width: 100%;">
              <FluentGridItem xs="12">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.Play()">
                  Visualizza
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="12">
                <FluentButton Style="width: 100%;" Appearance="Appearance.Accent" IconStart="new Icons.Regular.Size20.Edit()">
                  Modifica
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.DocumentArrowDown()">
                </FluentButton>
              </FluentGridItem>
              <FluentGridItem xs="6">
                <FluentButton Style="width: 100%;" IconStart="new Icons.Regular.Size20.Share()">
                </FluentButton>
              </FluentGridItem>
            </FluentGrid>
          }
        </FluentStack>
      </Actions>
      <!-- TODO: Insert actions for other tables -->
    </DetailsCard>
  </FluentGridItem>
</FluentGrid>

@code {

  readonly ListingFilterDto _filters = new()
  {
    AgentId = Guid.Parse("2ac5ece6-2dd3-4db4-81e2-a824d010d181")
  };

  private ListingAgentCountersResponseDto? _listingCounters;

  private bool _isDetailsCardLoading;
  private Dictionary<string, string>? _detailsCardTopSection;
  private Dictionary<string, string>? _detailsCardBottomSection;
  private object? _loadedItem;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;
    _listingCounters = await ListingApiService.GetListingAgentCountersAsync(_filters.AgentId);
    StateHasChanged();
  }

  private async Task<PagedResponseDto<ListingResponseDto>> GetListingData(int? pageNumber, int? pageSize)
  {
    return await ListingApiService.GetListingsByAgentIdAsync(_filters, pageNumber, pageSize);
  }

  private void OnListingRowClick(ListingResponseDto listing)
  {
    _isDetailsCardLoading = true;
    _detailsCardTopSection = new Dictionary<string, string>()
    {
      { "Nome", listing.Name },
      { "Città", listing.City },
      { "Indirizzo", listing.Address },
      { "Tipologia", listing.Type },
      { "Prezzo", listing.Price.ToString("C", new CultureInfo("it-IT")) },
      { "Disponibilità", listing.Available ? "Disponibile" : "Occupata" },
      { "Servizi disponibili", listing.Services.Count().ToString() }
    };
    _detailsCardBottomSection = new Dictionary<string, string>()
    {
      { "Visualizzazioni", "350" },
      { "Preferiti", "123" },
      { "Offerenti", "75" },
      { "Offerte", "24" },
      { "Prenotazioni", "17" }
    };
    _loadedItem = listing;
    _isDetailsCardLoading = false;
  }

}