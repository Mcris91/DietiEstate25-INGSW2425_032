@page "/View/{ListingId:guid}"
@using DietiEstate.WebClient.ApiService
@using DietiEstate.WebClient.Data.Requests
@using DietiEstate.WebClient.Data.Responses
@inject ListingApiService ListingApiService
@inject OfferApiService OfferApiService
@rendermode InteractiveServer

@if (_listing == null)
{
    <FluentGrid Style="margin: 1rem 3rem;">
        <FluentGridItem xs="12" md="7">
            <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Height="200px" Visible="true"/>
        </FluentGridItem>
        
        <FluentGridItem xs="12" md="5">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="5">
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Visible="true"/>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Visible="true"/>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Visible="true"/>
            </FluentStack>
        </FluentGridItem>
        
        <FluentGridItem xs="12" md="7">
            <FluentCard>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Height="200px" Visible="true"/>
            </FluentCard>        
        </FluentGridItem>
        
        <FluentGridItem xs="12" md="5">
            <FluentCard>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Height="200px" Visible="true"/>
            </FluentCard> 
        </FluentGridItem>
        
        <FluentGridItem xs="12" md="5">
            <FluentCard>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Height="200px" Visible="true"/>
            </FluentCard>
        </FluentGridItem>
        
        <FluentGridItem xs="12" md="7">
            <FluentCard>
                <FluentSkeleton Shape="SkeletonShape.Rect" Fill="true" Width="100%" Height="200px" Visible="true"/>
            </FluentCard>
        </FluentGridItem>
    </FluentGrid>
}
else
{
    <FluentGrid Style="margin: 1rem 3rem;">
        <FluentGridItem xs="12" md="7">
            <img src="@_listing.FeaturedImage" alt="ListingImage" class="rounded-lg" style="object-fit: cover" width="100%">
        </FluentGridItem>
        <FluentGridItem xs="12" md="5">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="5">
                @foreach (var image in _listing.Images)
                {
                    <img src="@image.Url" alt="ListingImage" class="rounded-lg" style="object-fit: cover" width="100%">
                }
            </FluentStack>
        </FluentGridItem>
        <FluentGridItem xs="12" md="7">
            <FluentCard>
                <FluentStack Orientation="Orientation.Vertical" Style="height: 100%; width: 100%">
                    <FluentLabel Typo="Typography.H4">Caratteristiche</FluentLabel>
                    <FluentStack Orientation="Orientation.Horizontal" Style="width: 100%; height: 100%; justify-content: space-between;">
                        <FluentStack Orientation="Orientation.Vertical" Style="flex-grow: 1; justify-content: space-between">
                            <FluentLabel Typo="Typography.H5"> Quadratura</FluentLabel>
                            <FluentLabel Typo="Typography.H5"> Classe energetica</FluentLabel>
                            <FluentLabel Typo="Typography.H5"> Camere da letto</FluentLabel>
                            <FluentLabel Typo="Typography.H5"> Piano </FluentLabel>
                            <FluentLabel Typo="Typography.H5"> Ascensore </FluentLabel>
                            <FluentLabel Typo="Typography.H5"> Riscaldamento </FluentLabel>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" Style="flex-grow: 1; justify-content: space-between">
                            <FluentLabel Typo="Typography.H5">@_listing.Dimensions Mq</FluentLabel>
                            <FluentLabel Typo="Typography.H5">@_listing.EnergyClass </FluentLabel>
                            <FluentLabel Typo="Typography.H5">@_listing.Rooms </FluentLabel>
                            <FluentLabel Typo="Typography.H5"> @_listing.Floor </FluentLabel>
                            <FluentLabel Typo="Typography.H5"> @(_listing.Elevator ? "Si" : "No") </FluentLabel>
                            <FluentLabel Typo="Typography.H5"> No </FluentLabel>
                        </FluentStack>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
        <FluentGridItem xs="12" md="5">
            <FluentCard>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Typo="Typography.H4"> Costi e contatti </FluentLabel>
                    
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="0">
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="0">
                            <FluentIcon Value="@(new Icons.Regular.Size24.Money())" Color="Color.Neutral"/>
                            <FluentLabel Typo="Typography.H6">Prezzo: </FluentLabel>
                            <FluentBadge BackgroundColor="black" Circular="true">$@_listing.Price</FluentBadge>
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="0">
                            <FluentIcon Value="@(new Icons.Regular.Size24.Building())" Color="Color.Neutral"/>
                            <FluentLabel Typo="Typography.H6">Condominio: </FluentLabel>
                            <FluentBadge Circular="true">$prezzo</FluentBadge>
                        </FluentStack>
                    </FluentStack>
                    
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="5">
                        <FluentLabel Typo="Typography.H4"> Agente immobiliare </FluentLabel>
                        
                        <FluentCard>
                            <FluentStack VerticalAlignment="VerticalAlignment.Center">
                                <div style=" background-color: red;
                                    width: 48px; 
                                    height: 48px; 
                                    border-radius: 50%; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-weight: bold;
                                    flex-shrink: 0;">
                                    @_listing.Agent.FirstName[0]@_listing.Agent.LastName[0]
                                </div>
                                <FluentStack Orientation="Orientation.Vertical">
                                    <FluentLabel Typo="Typography.H6">@_listing.Agent.FirstName @_listing.Agent.LastName</FluentLabel>
                                    <FluentLabel Typo="Typography.H6">@_listing.Agent.Email</FluentLabel>
                                </FluentStack>
                            </FluentStack>
                        </FluentCard>
                        @if (_makeOffer)
                        {
                            <FluentStack Orientation="Orientation.Vertical">
                                <FluentNumberField TValue="decimal" Label="Importo($)" Appearance="FluentInputAppearance.Outline" @bind-Value="@_offer.Value" Style="width: 100%"></FluentNumberField>
                                <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Send())" OnClick="MakeOffer" Style="width: 100%"></FluentButton>
                            </FluentStack>
                        }
                        else
                        {
                            <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Edit())" OnClick="@(() => _makeOffer = true)" Style="width: 100%">
                                Fai un'offerta
                            </FluentButton>
                        }
                        <FluentButton Appearance="Appearance.Neutral" IconStart="@(new Icons.Regular.Size20.Calendar())" Style="width: 100%">
                            Prenota un appuntamento
                        </FluentButton>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>

        <FluentGridItem xs="12" md="5">
            <FluentCard>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Typo="Typography.H4">Servizi nelle vicinanze</FluentLabel>

                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="0" Style="width: 100%; max-width: 500px;">
                        <FluentLabel Typo="Typography.H6"> Piano </FluentLabel>
                        <FluentLabel Typo="Typography.H6"> Camere da letto </FluentLabel>
                        <FluentLabel Typo="Typography.H6"> Bagni </FluentLabel>

                        @if (_showAll)
                        {
                            <FluentLabel Typo="Typography.H6"> Quadratura </FluentLabel>
                            <FluentLabel Typo="Typography.H6"> Posti auto </FluentLabel>
                            <FluentLabel Typo="Typography.H6"> Riscaldamento </FluentLabel>
                        }
                    </FluentStack>
                </FluentStack>
                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <FluentButton Appearance="Appearance.Stealth"
                                  Style="font-weight: bold;"
                                  OnClick="@(() => _showAll = !_showAll)">
                        @(_showAll ? "Mostra meno" : "Mostra tutto")
                    </FluentButton>
                </div>
            </FluentCard>
        </FluentGridItem>

        <FluentGridItem xs="12" md="7">
            <FluentCard>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Typo="Typography.H3">Descrizione</FluentLabel>
                    <FluentLabel Typo="Typography.Body">@_listing.Description</FluentLabel>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    </FluentGrid>
}




@code {
    [Parameter] public Guid ListingId { get; set; }

    ListingResponseDto? _listing;
    OfferRequestDto? _offer;
    private bool _showAll;
    private bool _makeOffer;
    
    protected override async Task OnInitializedAsync()
    {
        _listing = await ListingApiService.GetListingByIdAsync(ListingId);
        _offer = new OfferRequestDto()
        {
            AgentId = _listing.Agent.Id,
            ListingId = _listing.Id,
            CustomerId = _listing.Agent.Id
        };
    }

    public async Task MakeOffer()
    {
        if (_offer != null && _offer.Value > 0 && _listing != null && _offer.Value < _listing.Price)
        {
            await OfferApiService.PostOfferAsync(_offer);
            _makeOffer = false;
        }
    }
}